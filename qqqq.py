# -*- coding: utf-8 -*-
"""Flter.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Aiz4T1m3M1mvskDes2fuGtFoV6HegcCZ
"""

!pip install ipywidgets
import yfinance as yf
import pandas as pd

import requests

# Ù†Ø­Ù…Ù„ Ø±Ù…ÙˆØ² Ù†Ø§Ø³Ø¯Ø§Ùƒ Ù…Ù† Ù…Ù„Ù Ø¬Ø§Ù‡Ø²
nasdaq_url = "https://datahub.io/core/nasdaq-listings/r/nasdaq-listed.csv"
response = requests.get(nasdaq_url)

# Ù†Ø­ÙˆÙ„ Ø§Ù„Ù…Ù„Ù Ù„Ù‚Ø§Ø¦Ù…Ø© Ø±Ù…ÙˆØ²
lines = response.text.splitlines()
symbols = [line.split(',')[0] for line in lines[1:]]

print(f"Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù… ÙÙŠ Ù†Ø§Ø³Ø¯Ø§Ùƒ: {len(symbols)}")
symbols[:10]  # Ù†Ø·Ø¨Ø¹ Ø£ÙˆÙ„ 10 Ø±Ù…ÙˆØ² Ù„Ù„ØªØ£ÙƒØ¯

import yfinance as yf
import pandas as pd
import requests
import ipywidgets as widgets
from IPython.display import display, clear_output, HTML
import time

# ØªØ­Ù…ÙŠÙ„ Ø±Ù…ÙˆØ² Ù†Ø§Ø³Ø¯Ø§Ùƒ
nasdaq_url = "https://datahub.io/core/nasdaq-listings/r/nasdaq-listed.csv"
response = requests.get(nasdaq_url)
lines = response.text.splitlines()
symbols = [line.split(',')[0] for line in lines[1:] if line.split(',')[0].isalpha()]
print(f"Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù… ÙÙŠ Ù†Ø§Ø³Ø¯Ø§Ùƒ: {len(symbols)}")

section_size = 500
num_sections = (len(symbols) + section_size - 1) // section_size

# Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
section_dropdown = widgets.Dropdown(
    options=[f'Ø§Ù„Ù‚Ø³Ù… {i+1}' for i in range(num_sections)],
    description='ğŸ“¦ Ø§Ù„Ù‚Ø³Ù…:',
    style={'description_width': 'initial'},
)

growth_type = widgets.ToggleButtons(
    options=['Ù†Ù…Ùˆ Ù…Ø¨Ø³Ø·', 'Ù†Ù…Ùˆ Ù…Ø±ÙƒØ¨'],
    description='ğŸ“ˆ Ù†ÙˆØ¹ Ø§Ù„Ù†Ù…Ùˆ:',
    style={'description_width': 'initial'},
)

timeframe_type = widgets.ToggleButtons(
    options=['Ø³Ù†ÙˆÙŠ', 'Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ'],
    description='ğŸ•“   Ø§Ù„ÙØªØ±Ø©:',
    style={'description_width': 'initial'},
)

margin_input = widgets.BoundedFloatText(
    value=25.0,
    min=0,
    max=100,
    step=1,
    description='ğŸ“Š CFC:',
    style={'description_width': 'initial'},
    layout=widgets.Layout(width='200px')
)

multiplier_input = widgets.BoundedFloatText(
    value=2.0,
    min=0.5,
    max=10,
    step=0.1,
    description='ğŸ’° Ø§Ù„Ø¹Ø§Ø¯Ù„:',
    style={'description_width': 'initial'},
    layout=widgets.Layout(width='200px')
)

start_button = widgets.Button(description='ğŸ” Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙØ­Øµ', button_style='success')
results_button = widgets.Button(description='ğŸ“ Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬', button_style='info')

progress = widgets.IntProgress(value=0, min=0, max=100, layout=widgets.Layout(width='60%'))
progress_label = widgets.Label("0%", layout=widgets.Layout(width='50px'))

output = widgets.Output()
summary_label = widgets.HTML()

all_results = {}

def calculate_dcf(fcf, shares, simplified=True, years=10, growth=0.15, discount=0.11, terminal_growth=0.04):
    if simplified:
        return (fcf / shares) * 10
    else:
        fcf_per_share = fcf / shares
        dcf_value = 0
        for year in range(1, years + 1):
            future_fcf = fcf_per_share * ((1 + growth) ** year)
            discounted_fcf = future_fcf / ((1 + discount) ** year)
            dcf_value += discounted_fcf
        terminal_value = (future_fcf * (1 + terminal_growth)) / (discount - terminal_growth)
        dcf_value += terminal_value / ((1 + discount) ** years)
        return dcf_value

def get_key(section, growth, timeframe):
    return f"{section} | {growth} | {timeframe}"

def on_start_clicked(b):
    output.clear_output()
    with output:
        start_button.description = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ..."
        start_button.disabled = True
        progress.value = 0
        progress_label.value = "0%"

        section_index = int(section_dropdown.value.split()[-1]) - 1
        simplified = growth_type.value == 'Ù†Ù…Ùˆ Ù…Ø¨Ø³Ø·'
        timeframe = timeframe_type.value
        min_margin = margin_input.value
        multiplier = multiplier_input.value

        key = get_key(section_dropdown.value, growth_type.value, timeframe)
        start = section_index * section_size
        end = start + section_size
        selected_symbols = symbols[start:end]

        passed_count = 0
        results_this_run = []

        for i, symbol in enumerate(selected_symbols):
            try:
                ticker = yf.Ticker(symbol)
                info = ticker.info
                fcf = info.get("freeCashflow")
                shares = info.get("sharesOutstanding")
                price = info.get("currentPrice")
                revenue = info.get("totalRevenue")
                if fcf and shares and price and revenue:
                    dcf = calculate_dcf(fcf, shares, simplified=simplified)
                    fcf_margin = (fcf / revenue) * 100
                    passed = dcf >= price * multiplier and fcf_margin >= min_margin
                    if symbol not in all_results:
                        all_results[symbol] = {
                            "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ": round(price, 2),
                            "Ø³Ù†ÙˆÙŠ Ù…Ø¨Ø³Ø·": None,
                            "Ø³Ù†ÙˆÙŠ Ù…Ø±ÙƒØ¨": None,
                            "Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ Ù…Ø¨Ø³Ø·": None,
                            "Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ Ù…Ø±ÙƒØ¨": None,
                        }
                    label_type = f"{timeframe} {'Ù…Ø¨Ø³Ø·' if simplified else 'Ù…Ø±ÙƒØ¨'}"
                    label_value = round(dcf, 2)
                    if passed:
                        passed_count += 1
                        all_results[symbol][label_type] = ("âœ”ï¸", label_value)
                        results_this_run.append((symbol, round(price, 2), round(fcf_margin, 2), label_value))
                    else:
                        all_results[symbol][label_type] = ("âŒ", label_value)
            except:
                continue

            if i % 5 == 0:
                progress.value = int((i + 1) / len(selected_symbols) * 100)
                progress_label.value = f"{progress.value}%"

        summary_label.value = f"""
        âœ… ØªÙ… ÙØ­Øµ <b>{len(selected_symbols)}</b> Ø³Ù‡Ù….<br>
        âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„ØªÙŠ Ø§Ø¬ØªØ§Ø²Øª Ø§Ù„ÙÙ„ØªØ±Ø©: <b>{passed_count}</b>
        """

        if results_this_run:
            rows = []
            for sym, price, margin, fair_value in results_this_run:
                rows.append({
                    "Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù…": sym,
                    "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ": price,
                    "Ù‡Ø§Ù…Ø´ FCF": f"{margin:.2f}%",
                    "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¹Ø§Ø¯Ù„": fair_value
                })
            df = pd.DataFrame(rows)
            html = df.to_html(escape=False, index=False)
            display(HTML(html))
        else:
            print("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ø§Ø¬ØªØ§Ø²Øª Ø§Ù„ÙÙ„ØªØ±Ø©.")

        start_button.description = "ğŸ” Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙØ­Øµ"
        start_button.disabled = False

def on_show_results(b):
    output.clear_output()
    with output:
        rows = []
        for symbol, data in all_results.items():
            has_check = any(v is not None and v[0] == "âœ”ï¸" for k, v in data.items() if k != "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ")
            if has_check:
                row = {
                    "Ø±Ù…Ø² Ø§Ù„Ø³Ù‡Ù…": symbol,
                    "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ": data["Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ"]
                }
                for col in ["Ø³Ù†ÙˆÙŠ Ù…Ø±ÙƒØ¨", "Ø³Ù†ÙˆÙŠ Ù…Ø¨Ø³Ø·", "Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ Ù…Ø±ÙƒØ¨", "Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ Ù…Ø¨Ø³Ø·"]:
                    if data[col] is None:
                        row[col] = f'<span style="color:gray">â€”</span>'
                    else:
                        status, value = data[col]
                        color = "green" if status == "âœ”ï¸" else "red"
                        row[col] = f'<span style="color:{color}">{value}</span>'
                rows.append(row)

        if not rows:
            print("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù†Ø§Ø¬Ø­Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§.")
            return

        df = pd.DataFrame(rows)
        html = df.to_html(escape=False, index=False)
        display(HTML(html))

start_button.on_click(on_start_clicked)
results_button.on_click(on_show_results)

# Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
ui = widgets.VBox([
    section_dropdown,
    growth_type,
    timeframe_type,
    widgets.HBox([margin_input, multiplier_input]),
    widgets.HBox([start_button, results_button]),
    widgets.HBox([progress, progress_label]),
    summary_label,
    output
])

display(ui)